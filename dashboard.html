<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="color-scheme" content="dark" />
  <title>Ruko Admin Dashboard</title>
  <style>
    :root {
      --bg-0: #0b1220;
      --bg-1: #0f172a;
      --bg-2: #111c33;
      --card: rgba(255, 255, 255, 0.06);
      --card-2: rgba(255, 255, 255, 0.08);
      --border: rgba(255, 255, 255, 0.10);
      --text: #f1f5f9;
      --muted: rgba(241, 245, 249, 0.65);
      --muted-2: rgba(241, 245, 249, 0.45);
      --accent: #60a5fa;
      --accent-2: #3b82f6;
      --good: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
      --radius: 14px;
      --radius-sm: 10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background:
        radial-gradient(1100px 520px at 20% 0%, rgba(96, 165, 250, 0.14), transparent 55%),
        radial-gradient(950px 520px at 100% 10%, rgba(34, 197, 94, 0.10), transparent 55%),
        radial-gradient(900px 520px at 60% 100%, rgba(245, 158, 11, 0.10), transparent 55%),
        linear-gradient(180deg, var(--bg-0), var(--bg-1));
    }

    a { color: inherit; }
    button, input, select { font: inherit; }
    ::selection { background: rgba(96, 165, 250, 0.25); }

    .app {
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
      background: rgba(11, 18, 32, 0.55);
      border-bottom: 1px solid var(--border);
    }

    .topbar-inner {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .logo {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      background: linear-gradient(145deg, rgba(96, 165, 250, 0.25), rgba(96, 165, 250, 0.08));
      border: 1px solid rgba(96, 165, 250, 0.25);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.28);
      flex: 0 0 auto;
    }

    .brand-text { min-width: 0; }
    .brand h1 {
      margin: 0;
      font-size: 16px;
      font-weight: 650;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .subtitle {
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 0 0 auto;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      font-size: 12px;
      user-select: none;
      white-space: nowrap;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--muted-2);
      box-shadow: 0 0 0 5px rgba(241, 245, 249, 0.05);
    }
    .pill.ok .dot { background: var(--good); box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.14); }
    .pill.bad .dot { background: var(--bad); box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.14); }
    .pill.warn .dot { background: var(--warn); box-shadow: 0 0 0 5px rgba(245, 158, 11, 0.14); }

    .btn {
      appearance: none;
      border: 1px solid rgba(96, 165, 250, 0.35);
      color: var(--text);
      background: rgba(96, 165, 250, 0.12);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.12s ease, background 0.12s ease, border-color 0.12s ease;
      font-size: 13px;
      font-weight: 600;
    }

    .btn:hover { background: rgba(96, 165, 250, 0.18); border-color: rgba(96, 165, 250, 0.55); }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none; }

    .btn.secondary {
      border-color: var(--border);
      background: rgba(255, 255, 255, 0.06);
      font-weight: 600;
    }
    .btn.secondary:hover { background: rgba(255, 255, 255, 0.09); }

    .toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      font-size: 12px;
      color: var(--muted);
      user-select: none;
      white-space: nowrap;
    }

    .toggle input { width: 18px; height: 18px; accent-color: var(--accent); }

    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px;
      width: 100%;
      flex: 1 1 auto;
    }

    .stats-grid {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(12, 1fr);
      margin-top: 16px;
      margin-bottom: 14px;
    }

    .stat-card {
      grid-column: span 3;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.04));
      padding: 14px 14px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
      min-height: 86px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 10px;
    }

    .stat-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      min-width: 0;
    }

    .stat-label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 750;
      letter-spacing: -0.3px;
      font-variant-numeric: tabular-nums;
    }

    .stat-sub {
      color: var(--muted-2);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }

    .icon {
      width: 18px;
      height: 18px;
      color: rgba(241, 245, 249, 0.65);
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.04);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .panel-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.04);
      flex-wrap: wrap;
    }

    .tabs {
      display: inline-flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      padding: 9px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.12s ease, border-color 0.12s ease;
      font-size: 13px;
      font-weight: 650;
    }
    .tab:hover { background: rgba(255, 255, 255, 0.08); }
    .tab.active {
      background: rgba(96, 165, 250, 0.16);
      border-color: rgba(96, 165, 250, 0.5);
      color: var(--text);
    }

    .panel-head-actions {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .panel-body { padding: 14px; }

    .row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255, 255, 255, 0.04);
      padding: 14px;
      overflow: hidden;
    }

    .card-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .card-title h2 {
      margin: 0;
      font-size: 14px;
      font-weight: 750;
      letter-spacing: 0.2px;
    }

    .muted { color: var(--muted); }
    .muted-2 { color: var(--muted-2); }

    .chart {
      width: 100%;
      height: 180px;
      display: block;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.18);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .tool-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tool-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.07);
      background: rgba(255, 255, 255, 0.04);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.05);
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      user-select: none;
    }

    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: end;
      margin-bottom: 12px;
    }

    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); font-weight: 650; }

    input[type="text"], input[type="date"], select {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 10px;
      border-radius: 12px;
      outline: none;
      min-width: 220px;
    }
    select { min-width: 160px; }
    input[type="date"] { min-width: 160px; }

    input[type="text"]:focus, input[type="date"]:focus, select:focus {
      border-color: rgba(96, 165, 250, 0.7);
      box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.12);
    }

    .table-wrap {
      border-radius: var(--radius);
      border: 1px solid var(--border);
      overflow: hidden;
      background: rgba(0, 0, 0, 0.16);
    }

    table { width: 100%; border-collapse: collapse; font-size: 13px; }

    thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: rgba(15, 23, 42, 0.9);
      border-bottom: 1px solid var(--border);
      padding: 12px 12px;
      text-align: left;
      color: var(--muted);
      font-weight: 750;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      font-size: 11px;
      white-space: nowrap;
    }

    tbody td {
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      color: rgba(241, 245, 249, 0.92);
      vertical-align: top;
    }

    tbody tr { cursor: pointer; transition: background 0.12s ease; }
    tbody tr:hover { background: rgba(96, 165, 250, 0.08); }
    tbody tr.error-row:hover { background: rgba(239, 68, 68, 0.10); }

    .num { font-variant-numeric: tabular-nums; }
    .right { text-align: right; }
    .nowrap { white-space: nowrap; }
    .truncate { max-width: 540px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .link-btn {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      padding: 0;
      font-weight: 700;
      text-decoration: underline;
      text-decoration-color: rgba(96, 165, 250, 0.4);
      text-underline-offset: 3px;
    }
    .link-btn:hover { text-decoration-color: rgba(96, 165, 250, 0.9); }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.04);
      font-size: 12px;
      color: var(--muted);
      user-select: none;
      white-space: nowrap;
    }
    .badge.good { border-color: rgba(34, 197, 94, 0.35); color: rgba(34, 197, 94, 0.95); background: rgba(34, 197, 94, 0.08); }
    .badge.bad { border-color: rgba(239, 68, 68, 0.35); color: rgba(239, 68, 68, 0.98); background: rgba(239, 68, 68, 0.08); }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .pagination .meta { color: var(--muted); font-size: 12px; }
    .pagination .controls { display: inline-flex; gap: 10px; }

    .empty { padding: 28px 10px; text-align: center; color: var(--muted); font-size: 13px; }

    .skeleton {
      height: 12px;
      width: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg,
        rgba(255, 255, 255, 0.05),
        rgba(255, 255, 255, 0.10),
        rgba(255, 255, 255, 0.05)
      );
      background-size: 220% 100%;
      animation: shimmer 1.2s ease infinite;
    }

    @keyframes shimmer {
      0% { background-position: 0% 0%; }
      100% { background-position: 200% 0%; }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: rgba(0, 0, 0, 0.72);
      z-index: 1000;
    }
    .modal-overlay.active { display: flex; }

    .modal {
      width: 100%;
      max-width: 980px;
      max-height: 86vh;
      overflow: hidden;
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(15, 23, 42, 0.92);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.03);
    }
    .modal-header h2 { margin: 0; font-size: 15px; font-weight: 800; letter-spacing: 0.2px; }
    .modal-sub { margin-top: 4px; font-size: 12px; color: var(--muted); }

    .icon-btn {
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      cursor: pointer;
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 800;
      line-height: 1;
    }
    .icon-btn:hover { background: rgba(255, 255, 255, 0.08); }

    .modal-body { padding: 14px; overflow: auto; }

    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }

    .kv {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 8px 10px;
      align-items: baseline;
      font-size: 13px;
    }
    .kv .k { color: var(--muted); font-weight: 700; }
    .kv .v { font-variant-numeric: tabular-nums; overflow-wrap: anywhere; }

    .message-list { display: flex; flex-direction: column; gap: 10px; }
    .message {
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.04);
      padding: 12px 12px;
    }
    .message.user { background: rgba(255, 255, 255, 0.04); margin-left: 42px; }
    .message.assistant { background: rgba(96, 165, 250, 0.10); margin-right: 42px; border-color: rgba(96, 165, 250, 0.18); }
    .message.error { border-color: rgba(239, 68, 68, 0.30); background: rgba(239, 68, 68, 0.08); }
    .message.highlight { box-shadow: 0 0 0 5px rgba(245, 158, 11, 0.14); border-color: rgba(245, 158, 11, 0.35); }

    .message-head { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
    .role { text-transform: uppercase; font-size: 11px; letter-spacing: 0.6px; color: var(--muted); font-weight: 800; }
    .meta { display: inline-flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }

    .content { white-space: pre-wrap; line-height: 1.55; color: rgba(241, 245, 249, 0.92); }

    details {
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(0, 0, 0, 0.16);
      padding: 8px 10px;
    }
    summary { cursor: pointer; color: var(--muted); font-weight: 750; }
    pre.code {
      margin: 10px 0 0 0;
      padding: 10px 10px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.24);
      border: 1px solid rgba(255, 255, 255, 0.06);
      overflow: auto;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(241, 245, 249, 0.92);
    }

    .toast-stack {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1200;
      max-width: min(440px, calc(100vw - 32px));
    }
    .toast {
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(15, 23, 42, 0.94);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      padding: 12px 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      color: rgba(241, 245, 249, 0.92);
    }
    .toast .t { font-weight: 850; min-width: 62px; }
    .toast.err { border-color: rgba(239, 68, 68, 0.35); }
    .toast.ok { border-color: rgba(34, 197, 94, 0.35); }

    @media (max-width: 1050px) {
      .row { grid-template-columns: 1fr; }
      .stat-card { grid-column: span 4; }
    }
    @media (max-width: 760px) {
      .stat-card { grid-column: span 6; }
      input[type="text"] { min-width: 0; width: 100%; }
      .filters { align-items: stretch; }
      .field { flex: 1 1 220px; }
      .message.user { margin-left: 10px; }
      .message.assistant { margin-right: 10px; }
      .modal-grid { grid-template-columns: 1fr; }
      .kv { grid-template-columns: 120px 1fr; }
    }
  </style>
</head>
<body>
  <svg aria-hidden="true" style="position:absolute; width:0; height:0; overflow:hidden;">
    <symbol id="i-bolt" viewBox="0 0 24 24" fill="none">
      <path d="M13 2L3 14h8l-1 8 11-14h-8l0-6z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round" />
    </symbol>
    <symbol id="i-users" viewBox="0 0 24 24" fill="none">
      <path d="M17 21v-1a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v1" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      <path d="M9.5 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      <path d="M22 21v-1a3 3 0 0 0-2-2.83" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      <path d="M16 4.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
    </symbol>
    <symbol id="i-chat" viewBox="0 0 24 24" fill="none">
      <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-mail" viewBox="0 0 24 24" fill="none">
      <path d="M4 4h16v16H4V4z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
      <path d="M22 6l-10 7L2 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-clock" viewBox="0 0 24 24" fill="none">
      <path d="M12 22a10 10 0 1 0 0-20 10 10 0 0 0 0 20z" stroke="currentColor" stroke-width="1.8"/>
      <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-alert" viewBox="0 0 24 24" fill="none">
      <path d="M12 9v4" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
      <path d="M12 17h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/>
      <path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="currentColor" stroke-width="1.8" stroke-linejoin="round"/>
    </symbol>
  </svg>

  <div class="app">
    <header class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <svg class="icon" style="width:20px; height:20px; color:rgba(96,165,250,0.95)"><use href="#i-bolt"></use></svg>
          </div>
          <div class="brand-text">
            <h1>Ruko Admin Dashboard</h1>
            <div class="subtitle" id="subtitle">Loading...</div>
          </div>
        </div>
        <div class="top-actions">
          <div class="pill" id="statusPill" title="Database status">
            <span class="dot" aria-hidden="true"></span>
            <span id="statusText">Checking DB...</span>
          </div>
          <label class="toggle" title="Auto refresh every 30s">
            <input type="checkbox" id="autoRefresh" checked />
            Auto refresh
          </label>
          <button class="btn" id="refreshBtn" type="button">Refresh</button>
        </div>
      </div>
    </header>

    <main class="container">
      <section class="stats-grid" aria-label="Key metrics">
        <div class="stat-card">
          <div class="stat-top">
            <div class="stat-label">Total Users</div>
            <svg class="icon" aria-hidden="true"><use href="#i-users"></use></svg>
          </div>
          <div class="stat-value" id="statTotalUsers">—</div>
          <div class="stat-sub" id="statUsersSub">—</div>
        </div>

        <div class="stat-card">
          <div class="stat-top">
            <div class="stat-label">Conversations</div>
            <svg class="icon" aria-hidden="true"><use href="#i-chat"></use></svg>
          </div>
          <div class="stat-value" id="statTotalConversations">—</div>
          <div class="stat-sub" id="statConversationsSub">—</div>
        </div>

        <div class="stat-card">
          <div class="stat-top">
            <div class="stat-label">Messages (24h)</div>
            <svg class="icon" aria-hidden="true"><use href="#i-mail"></use></svg>
          </div>
          <div class="stat-value" id="statMessages24h">—</div>
          <div class="stat-sub" id="statMessagesSub">—</div>
        </div>

        <div class="stat-card">
          <div class="stat-top">
            <div class="stat-label">Errors (24h)</div>
            <svg class="icon" aria-hidden="true"><use href="#i-alert"></use></svg>
          </div>
          <div class="stat-value" id="statErrors24h">—</div>
          <div class="stat-sub" id="statErrorsSub">—</div>
        </div>

        <div class="stat-card">
          <div class="stat-top">
            <div class="stat-label">Avg Response (7d)</div>
            <svg class="icon" aria-hidden="true"><use href="#i-clock"></use></svg>
          </div>
          <div class="stat-value" id="statAvgRt7d">—</div>
          <div class="stat-sub" id="statP95Rt7d">—</div>
        </div>

        <div class="stat-card">
          <div class="stat-top">
            <div class="stat-label">Active Users (Today)</div>
            <svg class="icon" aria-hidden="true"><use href="#i-users"></use></svg>
          </div>
          <div class="stat-value" id="statActiveToday">—</div>
          <div class="stat-sub" id="statLastEvent">—</div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-head">
          <div class="tabs" role="tablist" aria-label="Dashboard sections">
            <button class="tab active" type="button" data-tab="overview" role="tab" aria-selected="true">Overview</button>
            <button class="tab" type="button" data-tab="conversations" role="tab" aria-selected="false">Conversations</button>
            <button class="tab" type="button" data-tab="users" role="tab" aria-selected="false">Users</button>
            <button class="tab" type="button" data-tab="errors" role="tab" aria-selected="false">Errors</button>
          </div>
          <div class="panel-head-actions">
            <div class="chip" id="hint">Tip: Press <span style="font-family:var(--mono); color:rgba(241,245,249,0.9)">Ctrl</span> + <span style="font-family:var(--mono); color:rgba(241,245,249,0.9)">K</span> to focus search</div>
          </div>
        </div>

        <div class="panel-body">
          <div class="tab-panel active" id="panel-overview" role="tabpanel">
            <div class="row">
              <div class="card">
                <div class="card-title">
                  <h2>Message Volume (Last 24 Hours)</h2>
                  <div class="chip" id="chartMeta">—</div>
                </div>
                <canvas class="chart" id="hourlyChart"></canvas>
                <div class="muted-2" style="margin-top:10px; font-size:12px;">
                  Bars: messages per hour. Line: errors per hour.
                </div>
              </div>
              <div class="card">
                <div class="card-title">
                  <h2>Top Tools (Last 7 Days)</h2>
                  <div class="chip" id="toolsMeta">—</div>
                </div>
                <div class="tool-list" id="toolsList"></div>
                <div class="muted-2" style="margin-top:10px; font-size:12px;">
                  Tools are extracted from the <span style="font-family:var(--mono)">tools_used</span> array on assistant messages.
                </div>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="panel-conversations" role="tabpanel">
            <div class="filters">
              <div class="field" style="flex: 1 1 320px;">
                <label for="convSearch">Search</label>
                <input type="text" id="convSearch" placeholder="Name, email, Teams ID..." />
              </div>
              <div class="field">
                <label for="convFrom">From</label>
                <input type="date" id="convFrom" />
              </div>
              <div class="field">
                <label for="convTo">To</label>
                <input type="date" id="convTo" />
              </div>
              <div class="field">
                <label for="convHasError">Errors</label>
                <select id="convHasError">
                  <option value="">All</option>
                  <option value="true">Only with errors</option>
                  <option value="false">No errors</option>
                </select>
              </div>
              <button class="btn secondary" id="convClear" type="button">Clear</button>
            </div>

            <div class="table-wrap">
              <table aria-label="Conversations table">
                <thead>
                  <tr>
                    <th>User</th>
                    <th class="right">Messages</th>
                    <th class="right">Errors</th>
                    <th class="right">Avg RT</th>
                    <th class="nowrap">Started</th>
                    <th class="nowrap">Last Message</th>
                  </tr>
                </thead>
                <tbody id="convTbody"></tbody>
              </table>
            </div>

            <div class="pagination">
              <div class="meta" id="convMeta">—</div>
              <div class="controls">
                <button class="btn secondary" id="convPrev" type="button">Prev</button>
                <button class="btn secondary" id="convNext" type="button">Next</button>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="panel-users" role="tabpanel">
            <div class="filters">
              <div class="field" style="flex: 1 1 320px;">
                <label for="userSearch">Search</label>
                <input type="text" id="userSearch" placeholder="Name, email, Teams ID..." />
              </div>
              <button class="btn secondary" id="userClear" type="button">Clear</button>
            </div>

            <div class="table-wrap">
              <table aria-label="Users table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th class="right">Conversations</th>
                    <th class="right">Messages</th>
                    <th class="right">Errors</th>
                    <th class="nowrap">Last Active</th>
                  </tr>
                </thead>
                <tbody id="userTbody"></tbody>
              </table>
            </div>

            <div class="pagination">
              <div class="meta" id="userMeta">—</div>
              <div class="controls">
                <button class="btn secondary" id="userPrev" type="button">Prev</button>
                <button class="btn secondary" id="userNext" type="button">Next</button>
              </div>
            </div>
          </div>

          <div class="tab-panel" id="panel-errors" role="tabpanel">
            <div class="filters">
              <div class="field" style="flex: 1 1 320px;">
                <label for="errSearch">Search content</label>
                <input type="text" id="errSearch" placeholder="Search in message content..." />
              </div>
              <div class="field">
                <label for="errFrom">From</label>
                <input type="date" id="errFrom" />
              </div>
              <div class="field">
                <label for="errTo">To</label>
                <input type="date" id="errTo" />
              </div>
              <button class="btn secondary" id="errClear" type="button">Clear</button>
            </div>

            <div class="table-wrap">
              <table aria-label="Errors table">
                <thead>
                  <tr>
                    <th class="nowrap">Time</th>
                    <th>User</th>
                    <th class="right">Conversation</th>
                    <th class="nowrap">Role</th>
                    <th>Error</th>
                  </tr>
                </thead>
                <tbody id="errTbody"></tbody>
              </table>
            </div>

            <div class="pagination">
              <div class="meta" id="errMeta">—</div>
              <div class="controls">
                <button class="btn secondary" id="errPrev" type="button">Prev</button>
                <button class="btn secondary" id="errNext" type="button">Next</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Details</h2>
          <div class="modal-sub" id="modalSub">—</div>
        </div>
        <button class="icon-btn" id="modalClose" type="button" aria-label="Close">×</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <div class="toast-stack" id="toastStack" aria-live="polite" aria-atomic="true"></div>

  <script>
    const API_BASE = "/admin";

    const state = {
      tab: "overview",
      autoRefresh: true,
      stats: null,
      activity: null,
      tools: null,
      lastRefresh: null,
      conversations: { limit: 25, offset: 0, total: 0, search: "", from: "", to: "", hasError: "" },
      users: { limit: 25, offset: 0, total: 0, search: "" },
      errors: { limit: 25, offset: 0, total: 0, search: "", from: "", to: "" },
      _timer: null,
    };

    const el = {
      subtitle: document.getElementById("subtitle"),
      statusPill: document.getElementById("statusPill"),
      statusText: document.getElementById("statusText"),
      autoRefresh: document.getElementById("autoRefresh"),
      refreshBtn: document.getElementById("refreshBtn"),

      statTotalUsers: document.getElementById("statTotalUsers"),
      statUsersSub: document.getElementById("statUsersSub"),
      statTotalConversations: document.getElementById("statTotalConversations"),
      statConversationsSub: document.getElementById("statConversationsSub"),
      statMessages24h: document.getElementById("statMessages24h"),
      statMessagesSub: document.getElementById("statMessagesSub"),
      statErrors24h: document.getElementById("statErrors24h"),
      statErrorsSub: document.getElementById("statErrorsSub"),
      statAvgRt7d: document.getElementById("statAvgRt7d"),
      statP95Rt7d: document.getElementById("statP95Rt7d"),
      statActiveToday: document.getElementById("statActiveToday"),
      statLastEvent: document.getElementById("statLastEvent"),

      chartMeta: document.getElementById("chartMeta"),
      hourlyChart: document.getElementById("hourlyChart"),
      toolsMeta: document.getElementById("toolsMeta"),
      toolsList: document.getElementById("toolsList"),

      convSearch: document.getElementById("convSearch"),
      convFrom: document.getElementById("convFrom"),
      convTo: document.getElementById("convTo"),
      convHasError: document.getElementById("convHasError"),
      convClear: document.getElementById("convClear"),
      convTbody: document.getElementById("convTbody"),
      convMeta: document.getElementById("convMeta"),
      convPrev: document.getElementById("convPrev"),
      convNext: document.getElementById("convNext"),

      userSearch: document.getElementById("userSearch"),
      userClear: document.getElementById("userClear"),
      userTbody: document.getElementById("userTbody"),
      userMeta: document.getElementById("userMeta"),
      userPrev: document.getElementById("userPrev"),
      userNext: document.getElementById("userNext"),

      errSearch: document.getElementById("errSearch"),
      errFrom: document.getElementById("errFrom"),
      errTo: document.getElementById("errTo"),
      errClear: document.getElementById("errClear"),
      errTbody: document.getElementById("errTbody"),
      errMeta: document.getElementById("errMeta"),
      errPrev: document.getElementById("errPrev"),
      errNext: document.getElementById("errNext"),

      modalOverlay: document.getElementById("modalOverlay"),
      modalTitle: document.getElementById("modalTitle"),
      modalSub: document.getElementById("modalSub"),
      modalClose: document.getElementById("modalClose"),
      modalBody: document.getElementById("modalBody"),

      toastStack: document.getElementById("toastStack"),
    };

    function escapeHtml(text) {
      const div = document.createElement("div");
      div.textContent = text ?? "";
      return div.innerHTML;
    }

    function fmtInt(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return "—";
      return new Intl.NumberFormat(undefined).format(num);
    }

    function fmtMs(value) {
      const num = Number(value);
      if (!Number.isFinite(num) || num <= 0) return "—";
      return `${fmtInt(num)}ms`;
    }

    function fmtDateTime(value) {
      if (!value) return "—";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "—";
      return d.toLocaleString(undefined, {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    function fmtRelative(value) {
      if (!value) return "—";
      const d = new Date(value);
      if (Number.isNaN(d.getTime())) return "—";
      const diffMs = Date.now() - d.getTime();
      const mins = Math.round(diffMs / 60000);
      if (mins < 1) return "just now";
      if (mins < 60) return `${mins}m ago`;
      const hours = Math.round(mins / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.round(hours / 24);
      return `${days}d ago`;
    }

    function toast(kind, title, message) {
      const node = document.createElement("div");
      node.className = `toast ${kind === "error" ? "err" : "ok"}`;
      node.innerHTML = `<div class="t">${escapeHtml(title)}</div><div class="m">${escapeHtml(message)}</div>`;
      el.toastStack.appendChild(node);
      setTimeout(() => node.remove(), 4500);
    }

    function setStatus({ level, text }) {
      el.statusPill.classList.remove("ok", "bad", "warn");
      if (level) el.statusPill.classList.add(level);
      el.statusText.textContent = text;
    }

    async function apiGet(path) {
      const res = await fetch(`${API_BASE}${path}`, { headers: { "Accept": "application/json" } });
      if (!res.ok) {
        let detail = "";
        try {
          const data = await res.json();
          detail = data?.detail || JSON.stringify(data);
        } catch (_) {
          detail = await res.text();
        }
        throw new Error(detail || `Request failed (${res.status})`);
      }
      return res.json();
    }

    function setLoadingRows(tbody, cols, rows = 8) {
      tbody.innerHTML = Array.from({ length: rows })
        .map(() => `<tr>${Array.from({ length: cols }).map(() => `<td><div class="skeleton"></div></td>`).join("")}</tr>`)
        .join("");
    }

    function setEmpty(tbody, cols, text) {
      tbody.innerHTML = `<tr><td colspan="${cols}"><div class="empty">${escapeHtml(text)}</div></td></tr>`;
    }

    function setTab(tab) {
      state.tab = tab;
      document.querySelectorAll(".tab").forEach((btn) => {
        const active = btn.dataset.tab === tab;
        btn.classList.toggle("active", active);
        btn.setAttribute("aria-selected", String(active));
      });
      document.querySelectorAll(".tab-panel").forEach((panel) => panel.classList.remove("active"));
      document.getElementById(`panel-${tab}`).classList.add("active");
      refreshCurrentTab();
    }

    function debounce(fn, ms) {
      let t = null;
      return (...args) => {
        if (t) clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    async function loadDbHealth() {
      try {
        const data = await apiGet("/db-health");
        setStatus({ level: "ok", text: `DB online · ${data.latency_ms}ms` });
      } catch (_) {
        setStatus({ level: "bad", text: "DB offline" });
      }
    }

    async function loadStats() {
      const data = await apiGet("/stats");
      state.stats = data;

      el.statTotalUsers.textContent = fmtInt(data.total_users);
      el.statUsersSub.textContent = `Total messages: ${fmtInt(data.total_messages)}`;

      el.statTotalConversations.textContent = fmtInt(data.total_conversations);
      el.statConversationsSub.textContent = `Messages today: ${fmtInt(data.messages_today)}`;

      el.statMessages24h.textContent = fmtInt(data.messages_24h);
      el.statMessagesSub.textContent = `Assistant: ${fmtInt(data.assistant_messages_24h)}`;

      el.statErrors24h.textContent = fmtInt(data.errors_24h);
      const errorRate = data.messages_24h ? Math.round((data.errors_24h / data.messages_24h) * 100) : 0;
      el.statErrorsSub.textContent = `Error rate: ${fmtInt(errorRate)}%`;

      el.statAvgRt7d.textContent = fmtMs(data.avg_response_time_ms_7d);
      el.statP95Rt7d.textContent = `P95: ${fmtMs(data.p95_response_time_ms_7d)} · P50: ${fmtMs(data.p50_response_time_ms_7d)}`;

      el.statActiveToday.textContent = fmtInt(data.active_users_today);
      el.statLastEvent.textContent = data.last_message_at ? `Last event: ${fmtRelative(data.last_message_at)}` : "Last event: —";

      state.lastRefresh = new Date();
      el.subtitle.textContent = `Updated ${state.lastRefresh.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" })} · ${data.last_message_at ? `Last event ${fmtRelative(data.last_message_at)}` : "No events yet"}`;
    }

    function resizeCanvasToDisplaySize(canvas) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));
      if (canvas.width !== w || canvas.height !== h) {
        canvas.width = w;
        canvas.height = h;
        return true;
      }
      return false;
    }

    function drawHourlyChart(points) {
      const canvas = el.hourlyChart;
      resizeCanvasToDisplaySize(canvas);
      const ctx = canvas.getContext("2d");
      if (!ctx) return;

      const w = canvas.width;
      const h = canvas.height;
      ctx.clearRect(0, 0, w, h);

      const padding = 16;
      const innerW = w - padding * 2;
      const innerH = h - padding * 2;

      const messages = points.map((p) => Number(p.messages) || 0);
      const errors = points.map((p) => Number(p.errors) || 0);
      const maxMsg = Math.max(1, ...messages);
      const maxErr = Math.max(1, ...errors);

      const barW = innerW / Math.max(1, points.length);
      const scaleYMsg = innerH / maxMsg;
      const scaleYErr = innerH / maxErr;

      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.lineWidth = 1;
      for (let i = 0; i <= 4; i++) {
        const y = padding + (innerH * i) / 4;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(w - padding, y);
        ctx.stroke();
      }

      for (let i = 0; i < points.length; i++) {
        const x = padding + i * barW;
        const m = messages[i];
        const barH = m * scaleYMsg;
        const y = padding + innerH - barH;
        ctx.fillStyle = "rgba(96,165,250,0.35)";
        ctx.fillRect(x + 1, y, Math.max(1, barW - 2), barH);
      }

      ctx.strokeStyle = "rgba(239,68,68,0.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for (let i = 0; i < points.length; i++) {
        const x = padding + i * barW + barW / 2;
        const e = errors[i];
        const lineY = padding + innerH - e * scaleYErr;
        if (i === 0) ctx.moveTo(x, lineY);
        else ctx.lineTo(x, lineY);
      }
      ctx.stroke();

      ctx.fillStyle = "rgba(241,245,249,0.75)";
      ctx.font = `${Math.max(11, Math.floor(12 * (window.devicePixelRatio || 1)))}px ui-sans-serif, system-ui`;
      ctx.fillText("messages", padding, padding + 12);
      ctx.fillStyle = "rgba(239,68,68,0.95)";
      ctx.fillText("errors", padding + 92, padding + 12);
    }

    async function loadActivity() {
      const data = await apiGet("/activity");
      state.activity = data;
      const hourly = Array.isArray(data.hourly) ? data.hourly : [];
      el.chartMeta.textContent = `Hours: ${fmtInt(hourly.length)}`;
      drawHourlyChart(hourly);
    }

    async function loadTools() {
      const data = await apiGet("/tools?limit=8");
      state.tools = data;
      const tools = Array.isArray(data.tools) ? data.tools : [];
      el.toolsMeta.textContent = `Tools: ${fmtInt(tools.length)}`;

      if (tools.length === 0) {
        el.toolsList.innerHTML = `<div class="empty">No tools recorded.</div>`;
        return;
      }

      el.toolsList.innerHTML = tools
        .map((t) => {
          const name = t.tool ?? "unknown";
          const count = Number(t.count) || 0;
          return `
            <div class="tool-item">
              <div style="font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(name)}</div>
              <span class="badge">${fmtInt(count)}</span>
            </div>
          `;
        })
        .join("");
    }

    async function loadConversations() {
      setLoadingRows(el.convTbody, 6);
      try {
        const p = state.conversations;
        const params = new URLSearchParams();
        params.set("limit", String(p.limit));
        params.set("offset", String(p.offset));
        if (p.search) params.set("search", p.search);
        if (p.from) params.set("date_from", p.from);
        if (p.to) params.set("date_to", p.to);
        if (p.hasError) params.set("has_error", p.hasError);

        const data = await apiGet(`/conversations?${params.toString()}`);
        state.conversations.total = Number(data.total) || 0;

        const rows = Array.isArray(data.conversations) ? data.conversations : [];
        if (rows.length === 0) {
          setEmpty(el.convTbody, 6, "No conversations found.");
        } else {
          el.convTbody.innerHTML = rows
            .map((c) => {
              const userLabel = c.display_name || c.email || c.ms_user_id || "Unknown";
              const errors = Number(c.error_count) || 0;
              const avgRt = Number(c.avg_assistant_response_time_ms) || 0;
              return `
                <tr data-conversation-id="${c.id}" data-user-id="${c.user_id ?? ""}" class="${errors > 0 ? "error-row" : ""}">
                  <td class="truncate"><button class="link-btn" type="button" data-action="user" data-user-id="${c.user_id ?? ""}">${escapeHtml(userLabel)}</button></td>
                  <td class="right num">${fmtInt(c.message_count)}</td>
                  <td class="right num">${errors > 0 ? `<span class="badge bad">${fmtInt(errors)}</span>` : `<span class="badge">0</span>`}</td>
                  <td class="right num">${avgRt ? fmtMs(avgRt) : "—"}</td>
                  <td class="nowrap">${fmtDateTime(c.started_at)}</td>
                  <td class="nowrap">${fmtDateTime(c.last_message_at)}</td>
                </tr>
              `;
            })
            .join("");
        }

        updatePager("conversations");
      } catch (e) {
        toast("error", "Error", String(e.message || e));
        setEmpty(el.convTbody, 6, "Failed to load conversations.");
      }
    }

    async function loadUsers() {
      setLoadingRows(el.userTbody, 6);
      try {
        const p = state.users;
        const params = new URLSearchParams();
        params.set("limit", String(p.limit));
        params.set("offset", String(p.offset));
        if (p.search) params.set("search", p.search);

        const data = await apiGet(`/users?${params.toString()}`);
        state.users.total = Number(data.total) || 0;

        const rows = Array.isArray(data.users) ? data.users : [];
        if (rows.length === 0) {
          setEmpty(el.userTbody, 6, "No users found.");
        } else {
          el.userTbody.innerHTML = rows
            .map((u) => {
              const name = u.display_name || u.ms_user_id || "Unknown";
              const email = u.email || "—";
              const errors = Number(u.error_count) || 0;
              return `
                <tr data-user-id="${u.id}">
                  <td class="truncate">${escapeHtml(name)}</td>
                  <td class="truncate muted">${escapeHtml(email)}</td>
                  <td class="right num">${fmtInt(u.conversation_count)}</td>
                  <td class="right num">${fmtInt(u.message_count)}</td>
                  <td class="right num">${errors > 0 ? `<span class="badge bad">${fmtInt(errors)}</span>` : `<span class="badge">0</span>`}</td>
                  <td class="nowrap">${fmtDateTime(u.last_active)}</td>
                </tr>
              `;
            })
            .join("");
        }

        updatePager("users");
      } catch (e) {
        toast("error", "Error", String(e.message || e));
        setEmpty(el.userTbody, 6, "Failed to load users.");
      }
    }

    async function loadErrors() {
      setLoadingRows(el.errTbody, 5);
      try {
        const p = state.errors;
        const params = new URLSearchParams();
        params.set("limit", String(p.limit));
        params.set("offset", String(p.offset));
        if (p.search) params.set("search", p.search);
        if (p.from) params.set("date_from", p.from);
        if (p.to) params.set("date_to", p.to);

        const data = await apiGet(`/errors?${params.toString()}`);
        state.errors.total = Number(data.total) || 0;

        const rows = Array.isArray(data.messages) ? data.messages : [];
        if (rows.length === 0) {
          setEmpty(el.errTbody, 5, "No errors found.");
        } else {
          el.errTbody.innerHTML = rows
            .map((m) => {
              const user = m.display_name || m.email || m.ms_user_id || "Unknown";
              const err = m.error || "Error";
              return `
                <tr class="error-row" data-conversation-id="${m.conversation_id}" data-message-id="${m.id}">
                  <td class="nowrap">${fmtDateTime(m.timestamp)}</td>
                  <td class="truncate">${escapeHtml(user)}</td>
                  <td class="right num">${fmtInt(m.conversation_id)}</td>
                  <td class="nowrap"><span class="badge">${escapeHtml(m.role || "—")}</span></td>
                  <td class="truncate">${escapeHtml(String(err))}</td>
                </tr>
              `;
            })
            .join("");
        }

        updatePager("errors");
      } catch (e) {
        toast("error", "Error", String(e.message || e));
        setEmpty(el.errTbody, 5, "Failed to load errors.");
      }
    }

    function updatePager(which) {
      if (which === "conversations") {
        const p = state.conversations;
        const start = p.total ? Math.min(p.total, p.offset + 1) : 0;
        const end = Math.min(p.total, p.offset + p.limit);
        el.convMeta.textContent = p.total ? `Showing ${fmtInt(start)}–${fmtInt(end)} of ${fmtInt(p.total)}` : "—";
        el.convPrev.disabled = p.offset <= 0;
        el.convNext.disabled = p.offset + p.limit >= p.total;
      } else if (which === "users") {
        const p = state.users;
        const start = p.total ? Math.min(p.total, p.offset + 1) : 0;
        const end = Math.min(p.total, p.offset + p.limit);
        el.userMeta.textContent = p.total ? `Showing ${fmtInt(start)}–${fmtInt(end)} of ${fmtInt(p.total)}` : "—";
        el.userPrev.disabled = p.offset <= 0;
        el.userNext.disabled = p.offset + p.limit >= p.total;
      } else if (which === "errors") {
        const p = state.errors;
        const start = p.total ? Math.min(p.total, p.offset + 1) : 0;
        const end = Math.min(p.total, p.offset + p.limit);
        el.errMeta.textContent = p.total ? `Showing ${fmtInt(start)}–${fmtInt(end)} of ${fmtInt(p.total)}` : "—";
        el.errPrev.disabled = p.offset <= 0;
        el.errNext.disabled = p.offset + p.limit >= p.total;
      }
    }

    function openModal({ title, sub, bodyHtml }) {
      el.modalTitle.textContent = title;
      el.modalSub.textContent = sub || "—";
      el.modalBody.innerHTML = bodyHtml || "";
      el.modalOverlay.classList.add("active");
      el.modalOverlay.setAttribute("aria-hidden", "false");
    }

    function closeModal() {
      el.modalOverlay.classList.remove("active");
      el.modalOverlay.setAttribute("aria-hidden", "true");
      el.modalBody.innerHTML = "";
    }

    async function openConversation(conversationId, highlightMessageId = null) {
      openModal({ title: `Conversation #${conversationId}`, sub: "Loading...", bodyHtml: `<div class="empty">Loading conversation...</div>` });
      try {
        const data = await apiGet(`/conversations/${conversationId}`);
        const c = data.conversation || {};
        const userLabel = c.display_name || c.email || c.ms_user_id || "Unknown";

        const headerHtml = `
          <div class="modal-grid">
            <div class="card">
              <div class="card-title"><h2>Conversation</h2><span class="chip">ID ${fmtInt(c.id)}</span></div>
              <div class="kv">
                <div class="k">User</div><div class="v">${escapeHtml(userLabel)}</div>
                <div class="k">Thread</div><div class="v">${escapeHtml(c.thread_id || "—")}</div>
                <div class="k">Started</div><div class="v">${fmtDateTime(c.started_at)}</div>
                <div class="k">Last message</div><div class="v">${fmtDateTime(c.last_message_at)}</div>
              </div>
            </div>
            <div class="card">
              <div class="card-title"><h2>Stats</h2><span class="chip">${fmtInt(c.total_messages)} msgs</span></div>
              <div class="kv">
                <div class="k">User msgs</div><div class="v">${fmtInt(c.user_messages)}</div>
                <div class="k">Assistant msgs</div><div class="v">${fmtInt(c.assistant_messages)}</div>
                <div class="k">Errors</div><div class="v">${Number(c.error_count) > 0 ? `<span class="badge bad">${fmtInt(c.error_count)}</span>` : `<span class="badge good">0</span>`}</div>
                <div class="k">Avg RT</div><div class="v">${fmtMs(c.avg_assistant_response_time_ms)}</div>
              </div>
            </div>
          </div>
        `;

        const messages = Array.isArray(data.messages) ? data.messages : [];
        const messagesHtml = messages.length
          ? `<div class="message-list">
              ${messages
                .map((m) => {
                  const classes = [
                    "message",
                    m.role === "assistant" ? "assistant" : "user",
                    m.error ? "error" : "",
                    highlightMessageId && Number(highlightMessageId) === Number(m.id) ? "highlight" : "",
                  ]
                    .filter(Boolean)
                    .join(" ");

                  const tools = Array.isArray(m.tools_used) ? m.tools_used : [];
                  const toolBadges = tools.map((t) => `<span class="badge">${escapeHtml(String(t))}</span>`).join("");
                  const rtBadge = m.response_time_ms ? `<span class="badge">${fmtMs(m.response_time_ms)}</span>` : "";
                  const errBadge = m.error ? `<span class="badge bad">error</span>` : "";

                  const detailsSql =
                    m.sql_query
                      ? `<details><summary>SQL query (${m.sql_results_count != null ? `${fmtInt(m.sql_results_count)} rows` : "results"})</summary><pre class="code">${escapeHtml(String(m.sql_query))}</pre></details>`
                      : "";
                  const detailsErr =
                    m.error ? `<details open><summary>Error details</summary><pre class="code">${escapeHtml(String(m.error))}</pre></details>` : "";

                  return `
                    <div class="${classes}" data-message-id="${m.id}">
                      <div class="message-head">
                        <div class="role">${escapeHtml(m.role || "message")}</div>
                        <div class="meta">
                          ${errBadge}
                          ${rtBadge}
                          <span class="badge">${escapeHtml(fmtDateTime(m.timestamp))}</span>
                          ${toolBadges}
                        </div>
                      </div>
                      <div class="content">${escapeHtml(String(m.content || ""))}</div>
                      ${detailsSql}
                      ${detailsErr}
                    </div>
                  `;
                })
                .join("")}
            </div>`
          : `<div class="empty">No messages in this conversation.</div>`;

        openModal({
          title: `Conversation with ${userLabel}`,
          sub: `Thread ${c.thread_id || "—"} · ${messages.length} messages`,
          bodyHtml: headerHtml + messagesHtml,
        });

        if (highlightMessageId) {
          const node = el.modalBody.querySelector(`[data-message-id="${highlightMessageId}"]`);
          if (node) node.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      } catch (e) {
        openModal({
          title: `Conversation #${conversationId}`,
          sub: "Failed to load",
          bodyHtml: `<div class="empty">Could not load conversation. ${escapeHtml(String(e.message || e))}</div>`,
        });
      }
    }

    async function openUser(userId) {
      if (!userId) return;
      openModal({ title: `User #${userId}`, sub: "Loading...", bodyHtml: `<div class="empty">Loading user...</div>` });
      try {
        const data = await apiGet(`/users/${userId}`);
        const u = data.user || {};
        const name = u.display_name || u.ms_user_id || "Unknown";
        const headerHtml = `
          <div class="modal-grid">
            <div class="card">
              <div class="card-title"><h2>User</h2><span class="chip">ID ${fmtInt(u.id)}</span></div>
              <div class="kv">
                <div class="k">Name</div><div class="v">${escapeHtml(name)}</div>
                <div class="k">Email</div><div class="v">${escapeHtml(u.email || "—")}</div>
                <div class="k">Teams ID</div><div class="v">${escapeHtml(u.ms_user_id || "—")}</div>
                <div class="k">Last active</div><div class="v">${fmtDateTime(u.last_active)}</div>
              </div>
            </div>
            <div class="card">
              <div class="card-title"><h2>Stats</h2><span class="chip">${fmtInt(u.conversation_count)} convs</span></div>
              <div class="kv">
                <div class="k">Conversations</div><div class="v">${fmtInt(u.conversation_count)}</div>
                <div class="k">Messages</div><div class="v">${fmtInt(u.message_count)}</div>
                <div class="k">Errors</div><div class="v">${Number(u.error_count) > 0 ? `<span class="badge bad">${fmtInt(u.error_count)}</span>` : `<span class="badge good">0</span>`}</div>
                <div class="k">First seen</div><div class="v">${fmtDateTime(u.first_seen)}</div>
              </div>
            </div>
          </div>
        `;

        const conversations = Array.isArray(data.conversations) ? data.conversations : [];
        const tableHtml = conversations.length
          ? `
            <div class="table-wrap">
              <table aria-label="User conversations">
                <thead>
                  <tr>
                    <th class="right">ID</th>
                    <th class="right">Messages</th>
                    <th class="right">Errors</th>
                    <th class="right">Avg RT</th>
                    <th class="nowrap">Last Message</th>
                  </tr>
                </thead>
                <tbody>
                  ${conversations
                    .map((c) => {
                      const errors = Number(c.error_count) || 0;
                      const avgRt = Number(c.avg_assistant_response_time_ms) || 0;
                      return `
                        <tr data-conversation-id="${c.id}">
                          <td class="right num">${fmtInt(c.id)}</td>
                          <td class="right num">${fmtInt(c.message_count)}</td>
                          <td class="right num">${errors > 0 ? `<span class="badge bad">${fmtInt(errors)}</span>` : `<span class="badge">0</span>`}</td>
                          <td class="right num">${avgRt ? fmtMs(avgRt) : "—"}</td>
                          <td class="nowrap">${fmtDateTime(c.last_message_at)}</td>
                        </tr>
                      `;
                    })
                    .join("")}
                </tbody>
              </table>
            </div>
          `
          : `<div class="empty">No conversations found for this user.</div>`;

        openModal({
          title: `User ${name}`,
          sub: `${fmtInt(u.message_count)} messages · ${fmtInt(u.conversation_count)} conversations`,
          bodyHtml: headerHtml + tableHtml,
        });

        el.modalBody.querySelectorAll("tr[data-conversation-id]").forEach((tr) => {
          tr.addEventListener("click", () => openConversation(tr.dataset.conversationId));
        });
      } catch (e) {
        openModal({
          title: `User #${userId}`,
          sub: "Failed to load",
          bodyHtml: `<div class="empty">Could not load user. ${escapeHtml(String(e.message || e))}</div>`,
        });
      }
    }

    async function refreshCurrentTab() {
      if (state.tab === "overview") {
        await Promise.allSettled([loadActivity(), loadTools()]);
        return;
      }
      if (state.tab === "conversations") return loadConversations();
      if (state.tab === "users") return loadUsers();
      if (state.tab === "errors") return loadErrors();
    }

    async function refreshAll() {
      el.refreshBtn.disabled = true;
      await Promise.allSettled([loadDbHealth(), loadStats()]);
      await refreshCurrentTab();
      el.refreshBtn.disabled = false;
    }

    function setupAutoRefresh() {
      if (state._timer) clearInterval(state._timer);
      if (!state.autoRefresh) return;
      state._timer = setInterval(() => {
        refreshAll().catch(() => {});
      }, 30000);
    }

    // Tabs
    document.querySelectorAll(".tab").forEach((btn) => btn.addEventListener("click", () => setTab(btn.dataset.tab)));

    // Modal handlers
    el.modalClose.addEventListener("click", closeModal);
    el.modalOverlay.addEventListener("click", (e) => {
      if (e.target === el.modalOverlay) closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && el.modalOverlay.classList.contains("active")) closeModal();
      if (e.ctrlKey && (e.key === "k" || e.key === "K")) {
        e.preventDefault();
        if (state.tab === "conversations") el.convSearch.focus();
        else if (state.tab === "users") el.userSearch.focus();
        else if (state.tab === "errors") el.errSearch.focus();
      }
    });

    // Top controls
    el.refreshBtn.addEventListener("click", () => refreshAll());
    el.autoRefresh.addEventListener("change", () => {
      state.autoRefresh = el.autoRefresh.checked;
      setupAutoRefresh();
      toast("ok", "Auto refresh", state.autoRefresh ? "Enabled (30s)" : "Disabled");
    });

    // Conversations filters
    const convSearchDebounced = debounce(() => {
      state.conversations.offset = 0;
      state.conversations.search = el.convSearch.value.trim();
      loadConversations();
    }, 250);
    el.convSearch.addEventListener("input", convSearchDebounced);
    el.convFrom.addEventListener("change", () => {
      state.conversations.offset = 0;
      state.conversations.from = el.convFrom.value;
      loadConversations();
    });
    el.convTo.addEventListener("change", () => {
      state.conversations.offset = 0;
      state.conversations.to = el.convTo.value;
      loadConversations();
    });
    el.convHasError.addEventListener("change", () => {
      state.conversations.offset = 0;
      state.conversations.hasError = el.convHasError.value;
      loadConversations();
    });
    el.convClear.addEventListener("click", () => {
      el.convSearch.value = "";
      el.convFrom.value = "";
      el.convTo.value = "";
      el.convHasError.value = "";
      state.conversations = { ...state.conversations, offset: 0, search: "", from: "", to: "", hasError: "" };
      loadConversations();
    });
    el.convPrev.addEventListener("click", () => {
      state.conversations.offset = Math.max(0, state.conversations.offset - state.conversations.limit);
      loadConversations();
    });
    el.convNext.addEventListener("click", () => {
      state.conversations.offset = state.conversations.offset + state.conversations.limit;
      loadConversations();
    });
    el.convTbody.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action='user']");
      if (btn) {
        const userId = btn.dataset.userId;
        if (userId) openUser(userId);
        e.stopPropagation();
        return;
      }
      const tr = e.target.closest("tr[data-conversation-id]");
      if (tr) openConversation(tr.dataset.conversationId);
    });

    // Users filters
    const userSearchDebounced = debounce(() => {
      state.users.offset = 0;
      state.users.search = el.userSearch.value.trim();
      loadUsers();
    }, 250);
    el.userSearch.addEventListener("input", userSearchDebounced);
    el.userClear.addEventListener("click", () => {
      el.userSearch.value = "";
      state.users = { ...state.users, offset: 0, search: "" };
      loadUsers();
    });
    el.userPrev.addEventListener("click", () => {
      state.users.offset = Math.max(0, state.users.offset - state.users.limit);
      loadUsers();
    });
    el.userNext.addEventListener("click", () => {
      state.users.offset = state.users.offset + state.users.limit;
      loadUsers();
    });
    el.userTbody.addEventListener("click", (e) => {
      const tr = e.target.closest("tr[data-user-id]");
      if (tr) openUser(tr.dataset.userId);
    });

    // Errors filters
    const errSearchDebounced = debounce(() => {
      state.errors.offset = 0;
      state.errors.search = el.errSearch.value.trim();
      loadErrors();
    }, 250);
    el.errSearch.addEventListener("input", errSearchDebounced);
    el.errFrom.addEventListener("change", () => {
      state.errors.offset = 0;
      state.errors.from = el.errFrom.value;
      loadErrors();
    });
    el.errTo.addEventListener("change", () => {
      state.errors.offset = 0;
      state.errors.to = el.errTo.value;
      loadErrors();
    });
    el.errClear.addEventListener("click", () => {
      el.errSearch.value = "";
      el.errFrom.value = "";
      el.errTo.value = "";
      state.errors = { ...state.errors, offset: 0, search: "", from: "", to: "" };
      loadErrors();
    });
    el.errPrev.addEventListener("click", () => {
      state.errors.offset = Math.max(0, state.errors.offset - state.errors.limit);
      loadErrors();
    });
    el.errNext.addEventListener("click", () => {
      state.errors.offset = state.errors.offset + state.errors.limit;
      loadErrors();
    });
    el.errTbody.addEventListener("click", (e) => {
      const tr = e.target.closest("tr[data-conversation-id]");
      if (!tr) return;
      openConversation(tr.dataset.conversationId, tr.dataset.messageId);
    });

    window.addEventListener("resize", debounce(() => {
      if (state.activity?.hourly) drawHourlyChart(state.activity.hourly);
    }, 150));

    // Initial load
    setupAutoRefresh();
    refreshAll()
      .then(() => Promise.allSettled([loadConversations(), loadUsers(), loadErrors()]))
      .catch((e) => toast("error", "Startup", String(e.message || e)));
  </script>
</body>
</html>
